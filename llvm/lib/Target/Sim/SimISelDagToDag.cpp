#include "MCTargetDesc/SimMCTargetDesc.h"
#include "Sim.h"
#include "SimTargetMachine.h"
#include "llvm/CodeGen/MachineFrameInfo.h"
#include "llvm/CodeGen/MachineFunction.h"
#include "llvm/CodeGen/MachineInstrBuilder.h"
#include "llvm/CodeGen/MachineRegisterInfo.h"
#include "llvm/CodeGen/SelectionDAG.h"
#include "llvm/CodeGen/SelectionDAGISel.h"
#include "llvm/CodeGen/TargetLowering.h"
#include "llvm/IR/CallingConv.h"
#include "llvm/IR/Constants.h"
#include "llvm/IR/DerivedTypes.h"
#include "llvm/IR/Function.h"
#include "llvm/IR/Intrinsics.h"
#include "llvm/IR/LLVMContext.h"
#include "llvm/Support/Compiler.h"
#include "llvm/Support/Debug.h"
#include "llvm/Support/ErrorHandling.h"
#include "llvm/Support/raw_ostream.h"

using namespace llvm;

#define DEBUG_TYPE "Sim-isel"

namespace {

class SimDAGToDAGISel : public SelectionDAGISel {
  const SimSubtarget *Subtarget = nullptr;

public:
  SimDAGToDAGISel(SimTargetMachine &TM, CodeGenOpt::Level OptLevel)
      : SelectionDAGISel(TM, OptLevel) {}

  bool runOnMachineFunction(MachineFunction &MF) override {
    Subtarget = &MF.getSubtarget<SimSubtarget>();
    return SelectionDAGISel::runOnMachineFunction(MF);
  }

  bool SelectAddrFI(SDValue Addr, SDValue &Base);
  bool SelectBaseAddr(SDValue Addr, SDValue &Base);

  void Select(SDNode *N) override;

  StringRef getPassName() const override {
    return "Sim DAG->DAG Pattern Instruction Selection";
  }

  static SimCC::CondCode getSimCCForIntCC(ISD::CondCode CC) {
    switch (CC) {
    case ISD::SETEQ:
      return SimCC::EQ;
    case ISD::SETNE:
      return SimCC::NE;
    case ISD::SETLE:
      return SimCC::LE;
    case ISD::SETGT:
      return SimCC::GT;
    case ISD::SETULE:
      return SimCC::LEU;
    case ISD::SETUGT:
      return SimCC::GTU;
    default:
      llvm_unreachable("");
    }
  }

// Include the pieces autogenerated from the target description.
#include "SimGenDAGISel.inc"
};

} // end anonymous namespace

// This pass converts a legalized DAG into a Sim-specific DAG, ready for
// instruction scheduling.
FunctionPass *llvm::createSimISelDag(SimTargetMachine &TM,
                                      CodeGenOpt::Level OptLevel) {
  return new SimDAGToDAGISel(TM, OptLevel);
}

bool SimDAGToDAGISel::SelectAddrFI(SDValue Addr, SDValue &Base) {
  if (auto *FIN = dyn_cast<FrameIndexSDNode>(Addr)) {
    Base = CurDAG->getTargetFrameIndex(FIN->getIndex(), MVT::i32);
    return true;
  }
  return false;
}

bool SimDAGToDAGISel::SelectBaseAddr(SDValue Addr, SDValue &Base) {
  if (auto *FIN = dyn_cast<FrameIndexSDNode>(Addr))
    Base = CurDAG->getTargetFrameIndex(FIN->getIndex(), MVT::i32);
  else
    Base = Addr;
  return true;
}

void SimDAGToDAGISel::Select(SDNode *Node) {
  if (Node->isMachineOpcode()) {
    LLVM_DEBUG(dbgs() << "== "; Node->dump(CurDAG); dbgs() << "\n");
    Node->setNodeId(-1);
    return;
  }
  unsigned Opcode = Node->getOpcode();
  SDLoc DL(Node);
  MVT VT = Node->getSimpleValueType(0);

  switch (Opcode) {
  case ISD::FrameIndex: {
    SDValue Imm = CurDAG->getTargetConstant(0, DL, MVT::i32);
    int FI = cast<FrameIndexSDNode>(Node)->getIndex();
    SDValue TFI = CurDAG->getTargetFrameIndex(FI, VT);
    ReplaceNode(Node, CurDAG->getMachineNode(Sim::ADDI, DL, VT, TFI, Imm));
    return;
  }
  case ISD::Constant: {
    auto *ConstNode = cast<ConstantSDNode>(Node);
    assert(VT == MVT::i32);
    int64_t Imm = ConstNode->getSExtValue();
    SDNode *Res = nullptr;
    if (isUInt<16>(Imm)) {
      SDValue SDImm = CurDAG->getTargetConstant(Imm, DL, MVT::i32);
      Res = CurDAG->getMachineNode(Sim::MOVLIu, DL, VT, SDImm);
    } else if (isInt<16>(Imm)) {
      SDValue SDImm = CurDAG->getTargetConstant(Imm, DL, MVT::i32);
      Res = CurDAG->getMachineNode(Sim::MOVLIs, DL, VT, SDImm);
    } else {
      // (h' << 16) + (l >> 15) * (-1 << 16) + l
      // ((h' + (l >> 15) * (-1 << 16)) + l
      // h + l,  h' = h - (l >> 15) * (-1 << 16)
      uint16_t ImmLi = (uint64_t)Imm & 0xffff;
      uint16_t ImmHi = ((uint64_t)Imm >> 16) - ((ImmLi >> 15) ? 0xffff : 0);
      SDValue SDImmLi = CurDAG->getTargetConstant(ImmLi, DL, MVT::i32);
      SDValue SDImmHi = CurDAG->getTargetConstant(ImmHi, DL, MVT::i32);
      Res = CurDAG->getMachineNode(Sim::MOVHI, DL, VT, SDImmHi);
      Res =
          CurDAG->getMachineNode(Sim::ADDI, DL, VT, SDValue(Res, 0), SDImmLi);
    }
    ReplaceNode(Node, Res);
    return;
  }
  }
  SelectCode(Node);
}
